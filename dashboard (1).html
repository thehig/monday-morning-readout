<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Owner Report</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Quicksand&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome für Navigation Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- CSS -->
    <style>
      body {
        margin: 0;
        padding: 20px 20px 80px 20px; /* unterer Padding, damit Footer nicht überlappt */
        background-color: rgb(30, 32, 71);
        font-family: "Quicksand", sans-serif;
        color: #ffffff;
      }
      /* Authentifizierungs–Panel: Statt vollständigem Vertical-Center ist jetzt nur ein Padding vom oberen Rand gesetzt */
      #authPanel {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding-top: 20px;
      }
      #authPanel input {
        font-size: 1.2em;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 4px;
        border: none;
        width: 80%;
        max-width: 300px;
      }
      #authPanel button {
        padding: 10px 20px;
        font-size: 1.2em;
        border: none;
        border-radius: 4px;
        background-color: rgba(244, 112, 42, 0.8);
        color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #authPanel button:hover {
        background-color: rgba(244, 112, 42, 1);
      }
      /* App-Panel – zunächst versteckt */
      #appPanel {
        display: none;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 2.5em;
      }
      .dashboard {
        display: grid;
        grid-template-columns: 1fr; /* Kleine Bildschirme: 1 Spalte */
        gap: 20px;
      }
      @media (min-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr 1fr;
        }
      }
      @media (min-width: 1200px) {
        .dashboard {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }
      .card {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        min-width: 320px;
      }
      .card h2 {
        margin-top: 0;
        margin-bottom: 10px;
        text-align: center;
      }
      .progress-container {
        margin-bottom: 20px;
        text-align: center;
        position: relative;
      }
      .progress-container canvas {
        width: 100% !important;
        max-width: 100%;
        height: auto !important;
        display: block;
        margin: 0 auto;
      }
      .gauges-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      .gauge-container {
        text-align: center;
      }
      .gauge-label {
        margin-top: 8px;
        font-weight: bold;
      }
      .nav-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 40px;
        margin-top: 40px;
      }
      .nav-btn {
        background-color: rgba(244, 112, 42, 0.8);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 1.5em;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .nav-btn:hover {
        background-color: rgba(244, 112, 42, 1);
      }
      .hidden {
        display: none;
      }
      /* Sticky Footer */
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgb(30, 32, 71);
        color: #fff;
        text-align: center;
        padding: 10px 0;
        font-size: 1em;
        box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.4);
        z-index: 100;
      }
    </style>
  </head>
  <body>
    <!-- Authentifizierungs-Panel -->
    <div id="authPanel">
      <h1>Please enter the password</h1>
      <form id="authForm">
        <input
          type="password"
          id="passwordInput"
          placeholder="Password"
          required
        />
        <button type="submit">Let's Go</button>
      </form>
    </div>

    <!-- App-Panel (wird nach erfolgreicher Authentifizierung sichtbar) -->
    <div id="appPanel">
      <h1 id="headerTitle">Product Owner Report - Woche --</h1>
      <div class="dashboard" id="dashboard">
        <!-- Hier werden die Cards dynamisch erzeugt -->
      </div>
      <div class="nav-buttons">
        <button id="backward" class="nav-btn" title="Vorherige Woche">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
        <button id="forward" class="nav-btn" title="Nächste Woche">
          <i class="fa-solid fa-arrow-right"></i>
        </button>
      </div>
      <footer>Built with ❤️ in Berlin</footer>
    </div>

    <!-- Supabase UMD-Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
    <!-- Canvas Gauges -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-gauges/gauge.min.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!-- CryptoJS für AES-Verschlüsselung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
      // Globale Funktion zum Verschlüsseln (für die Nutzung in der Konsole)
      window.encrypt = function (password, plaintext) {
        const encrypted = CryptoJS.AES.encrypt(plaintext, password).toString();
        console.log("Encrypted:", encrypted);
        return encrypted;
      };

      console.log('Use encrypt("password", "your_text") to encrypt values.');

      // Hilfsfunktion zum Anzeigen eines zentralen Fehlers
      function showError(msg) {
        document.body.innerHTML =
          "<div style='display:flex; align-items:center; justify-content:center; height:100vh; font-size:2em;'>" +
          msg +
          "</div>";
      }

      // Verschlüsselte Werte – bitte mit deinen eigenen verschlüsselten Strings ersetzen.
      const encryptedSupabaseUrl =
        "U2FsdGVkX18dNsPaFWkxSPhEHBQ5VjxJWF4DL1Vs/dHk3gHd8sSnJcYJY35JPd1TOUVx9+CtHRUd9lCRiTfB3w==";
      const encryptedSupabaseKey =
        "U2FsdGVkX1+LvMEWOo61r6IOitYkRVWwn2hMjF3Sf5QHLV9qUmd11OslB87yEhAH2O1OHKdGrLPUhF9Yr7C4+8oeSKMpN4n3LuOrJptfpWEq7KRYJ2xTW3An1T0RpitT+7sPPRElJA8nJ00y1wifnFKHrnnj+pK1rkLX0pwapb+cNyFLKtDMhzp9JznYFcKgP4t+nLnLjGCtKg5cROb9eyjf8rqdROghNB9/oZ1fv0ZG2XVm3DGMnGtAyAKHINRTG4Lo6zPOgQKd67CsEVw1kiYxN3WQbPKWy8K6RfUviOgudvKHk1XdeAbkS3L7By+4";

      // Authentifizierungs–Flow
      document
        .getElementById("authForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const password = document.getElementById("passwordInput").value;
          try {
            const decryptedUrlBytes = CryptoJS.AES.decrypt(
              encryptedSupabaseUrl,
              password
            );
            const decryptedKeyBytes = CryptoJS.AES.decrypt(
              encryptedSupabaseKey,
              password
            );
            const decryptedUrl = decryptedUrlBytes.toString(CryptoJS.enc.Utf8);
            const decryptedKey = decryptedKeyBytes.toString(CryptoJS.enc.Utf8);
            if (!decryptedUrl || !decryptedKey) {
              showError("No, no, no...");
              return;
            }
            console.log(decryptedUrl, decryptedKey);
            initApp(decryptedUrl, decryptedKey);
          } catch (err) {
            console.error(err);
            showError("No, no, no...");
          }
        });

      // Wird aufgerufen, wenn Authentifizierung erfolgreich war
      function initApp(decryptedUrl, decryptedKey) {
        document.getElementById("authPanel").style.display = "none";
        document.getElementById("appPanel").style.display = "block";

        const supabaseClient = supabase.createClient(
          decryptedUrl,
          decryptedKey
        );
        const velocityMapping = { Rot: 0, Gelb: 1, Grün: 2 };
        const currentWeek = moment().isoWeek();
        let calendar_week = currentWeek;

        const dashboard = document.getElementById("dashboard");
        const headerTitle = document.getElementById("headerTitle");
        const backwardBtn = document.getElementById("backward");
        const forwardBtn = document.getElementById("forward");

        function extractName(email) {
          if (!email) return "";
          const localPart = email.split("@")[0];
          const parts = localPart.split(".");
          const namePart = parts[0];
          return namePart.charAt(0).toUpperCase() + namePart.slice(1);
        }

        async function renderDashboard() {
          const monday = moment().isoWeek(calendar_week).startOf("isoWeek");
          const sunday = moment().isoWeek(calendar_week).endOf("isoWeek");
          const mondayFormatted = monday.format("DD.MM.YY");
          const sundayFormatted = sunday.format("DD.MM.YY");
          headerTitle.textContent =
            "Product Owner Report - Woche " +
            String(calendar_week).padStart(2, "0") +
            " - " +
            mondayFormatted +
            "-" +
            sundayFormatted;

          dashboard.innerHTML = "";

          const { data, error } = await supabaseClient
            .from("po_feedback")
            .select("*")
            .gte("created_at", monday.toISOString())
            .lte("created_at", sunday.toISOString());

          if (error) {
            dashboard.innerHTML =
              "<div style='text-align: center; font-size: 1.5em;'>Error: " +
              error.message +
              "</div>";
          } else if (!data || data.length === 0) {
            dashboard.innerHTML =
              "<div style='text-align: center; font-size: 1.5em;'>Ups, no data!</div>";
          } else {
            data.sort((a, b) =>
              extractName(a.submitted_by).localeCompare(
                extractName(b.submitted_by)
              )
            );
            data.forEach((record, index) => {
              const card = document.createElement("div");
              card.className = "card";
              dashboard.appendChild(card);

              const name = extractName(record.submitted_by);
              const cardHeader = document.createElement("h2");
              cardHeader.textContent = name;
              card.appendChild(cardHeader);

              const progressContainer = document.createElement("div");
              progressContainer.className = "progress-container";
              card.appendChild(progressContainer);

              const progressCanvas = document.createElement("canvas");
              const progressId = "progress_" + index;
              progressCanvas.id = progressId;
              progressContainer.appendChild(progressCanvas);

              const progressLabel = document.createElement("div");
              progressLabel.className = "gauge-label";
              progressLabel.textContent = "Fortschritt";
              progressContainer.appendChild(progressLabel);

              const gaugesRow = document.createElement("div");
              gaugesRow.className = "gauges-row";
              card.appendChild(gaugesRow);

              const velocityContainer = document.createElement("div");
              velocityContainer.className = "gauge-container";
              gaugesRow.appendChild(velocityContainer);

              const velocityCanvas = document.createElement("canvas");
              const velocityId = "velocity_" + index;
              velocityCanvas.id = velocityId;
              velocityContainer.appendChild(velocityCanvas);

              const velocityLabel = document.createElement("div");
              velocityLabel.className = "gauge-label";
              velocityLabel.textContent = "Geschwindigkeit";
              velocityContainer.appendChild(velocityLabel);

              const teamContainer = document.createElement("div");
              teamContainer.className = "gauge-container";
              gaugesRow.appendChild(teamContainer);

              const teamCanvas = document.createElement("canvas");
              const teamId = "team_" + index;
              teamCanvas.id = teamId;
              teamContainer.appendChild(teamCanvas);

              const teamLabel = document.createElement("div");
              teamLabel.className = "gauge-label";
              teamLabel.textContent = "Team Happiness";
              teamContainer.appendChild(teamLabel);

              const customerContainer = document.createElement("div");
              customerContainer.className = "gauge-container";
              gaugesRow.appendChild(customerContainer);

              const customerCanvas = document.createElement("canvas");
              const customerId = "customer_" + index;
              customerCanvas.id = customerId;
              customerContainer.appendChild(customerCanvas);

              const customerLabel = document.createElement("div");
              customerLabel.className = "gauge-label";
              customerLabel.textContent = "Kunden Happiness";
              customerContainer.appendChild(customerLabel);

              const cardInnerWidth = card.clientWidth - 40;
              const progressGaugeWidth =
                cardInnerWidth > 0 ? cardInnerWidth : 320;

              new LinearGauge({
                renderTo: progressId,
                width: progressGaugeWidth,
                height: 120,
                minValue: 0,
                maxValue: 100,
                value: record.progress_percent * 10,
                colorStart: "rgba(244,112,42,0.7)",
                colorStop: "rgba(244,112,42,1)",
                strokeTicks: true,
                highlights: [
                  { from: 0, to: 100, color: "rgba(244,112,42,0.3)" },
                ],
                majorTicks: [],
                minorTicks: 0,
                animation: false,
                barWidth: 10,
              }).draw();

              new RadialGauge({
                renderTo: velocityId,
                width: 80,
                height: 80,
                units: "",
                minValue: 0,
                maxValue: 2,
                value: velocityMapping[record.velocity_next_week],
                majorTicks: ["Rot", "Gelb", "Grün"],
                minorTicks: 0,
                ticksAngle: 180,
                startAngle: 90,
                valueInt: 0,
                valueDec: 0,
                needleType: "arrow",
                needleWidth: 2,
                borders: false,
                colorPlate: "rgba(30,32,71,0.9)",
                colorMajorTicks: "#ffffff",
                colorMinorTicks: "#ffffff",
                colorNumbers: "#ffffff",
                colorNeedle:
                  record.velocity_next_week === "Rot"
                    ? "red"
                    : record.velocity_next_week === "Gelb"
                    ? "yellow"
                    : "green",
                animationDuration: 1500,
                animationRule: "linear",
              }).draw();

              new RadialGauge({
                renderTo: teamId,
                width: 80,
                height: 80,
                units: "",
                minValue: 1,
                maxValue: 5,
                value: record.team_happiness,
                majorTicks: ["1", "2", "3", "4", "5"],
                minorTicks: 0,
                ticksAngle: 270,
                startAngle: 45,
                needleType: "arrow",
                needleWidth: 2,
                borders: false,
                colorPlate: "rgba(30,32,71,0.9)",
                colorMajorTicks: "#ffffff",
                colorMinorTicks: "#ffffff",
                colorNumbers: "#ffffff",
                colorNeedle: "rgb(49,162,248)",
                animationDuration: 1500,
                animationRule: "linear",
              }).draw();

              new RadialGauge({
                renderTo: customerId,
                width: 80,
                height: 80,
                units: "",
                minValue: 1,
                maxValue: 5,
                value: record.customer_happiness,
                majorTicks: ["1", "2", "3", "4", "5"],
                minorTicks: 0,
                ticksAngle: 270,
                startAngle: 45,
                needleType: "arrow",
                needleWidth: 2,
                borders: false,
                colorPlate: "rgba(30,32,71,0.9)",
                colorMajorTicks: "#ffffff",
                colorMinorTicks: "#ffffff",
                colorNumbers: "#ffffff",
                colorNeedle: "rgb(49,162,248)",
                animationDuration: 1500,
                animationRule: "linear",
              }).draw();
            });
          }

          if (calendar_week >= currentWeek) {
            forwardBtn.classList.add("hidden");
          } else {
            forwardBtn.classList.remove("hidden");
          }
        }

        backwardBtn.addEventListener("click", async () => {
          calendar_week--;
          await renderDashboard();
        });

        forwardBtn.addEventListener("click", async () => {
          if (calendar_week < currentWeek) {
            calendar_week++;
            await renderDashboard();
          }
        });

        renderDashboard();
      }
    </script>
  </body>
</html>
